<div class="spotify-container">
    <div class="row">
        <div class="col-3 fix-spotify">
            <div id='profile-spotify' class="card ">
                <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPgvBgACHgEXvIm+6QAAAABJRU5ErkJggg==" class="card-img-top rounded-circle width35 " alt="...">
                <div class="card-body">
                    <h5 class="card-title">Card title</h5>
                    <a href="">Profile</a>
                </div>
            </div>
        </div>
        <div class="col-9  container-result fix-spotify black">
            <div>
                <form id="SpotifySnapform" autocomplete="off">
                    <input type="text" class="form-control" id="SearchSpotify" placeholder="Escribir...">
                    <button type="submit" class="btn btn-primary mb-2" style="display: none">Buscar</button>
                </form>
                <div id="result" class="result row "></div>
            </div>
        </div>
    </div>
    <div class="row">
        <div id="currentSong" class="col-3 fix-spotify">
            <div class="card">
                <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPgvBgACHgEXvIm+6QAAAABJRU5ErkJggg==" class="card-img-top" alt="...">
                <div class="card-body">
                    <p class="card-title"></p>
                    <p class="card-text"></p>
                    <i data-status='play' class="fa fa-play-circle" onclick="controls.click(this)"></i>
                </div>
            </div>
        </div>
        <div class="col-9 fix-spotify black">
            
        </div>
    </div>
</div>
<script type="text/javascript">
var player;
let controls = {

    click: function(e) {
        e.classList.toggle('fa-play-circle');
        e.classList.toggle('fa-pause-circle');
        player.togglePlay()
    }
}

document.addEventListener('DOMContentLoaded', function(event) {
    let urlParams = new URLSearchParams(location.search);
    const token = urlParams.get('access_token');
    let SpotifySnap = new SpotifyPlayers({
        token: token
    });

    let RenderPreview = (track) => {
        let { album, uri } = track;
        let Preview = document.querySelector("#currentSong");
        if (uri != Preview.dataset.trackId) {
            Preview.dataset.trackId = track.uri;
            Preview.querySelector('img').src = album.images[0].url;
            Preview.querySelector('.card-title').innerText = track.name;
            Preview.querySelector('.card-text').innerText = track.artists[0].name;
            Preview.querySelector('i').click();
        }


    }


    window.onSpotifyWebPlaybackSDKReady = () => {
        let urlParams = new URLSearchParams(location.search);
        const token = urlParams.get('access_token');
        player = new Spotify.Player({
            name: 'SnapSoptify',
            getOAuthToken: cb => { cb(token); }
        });

        // Error handling
        player.addListener('initialization_error', ({ message }) => { console.error(message); });
        player.addListener('authentication_error', ({ message }) => { console.error(message); });
        player.addListener('account_error', ({ message }) => { console.error(message); });
        player.addListener('playback_error', ({ message }) => { console.error(message); });

        // Playback status updates
        player.addListener('player_state_changed', state => {
            let { track_window } = state;
            RenderPreview(track_window.current_track);
        });

        // Ready
        player.addListener('ready', ({ device_id }) => {
            console.log('Ready with Device ID', device_id);
            SpotifySnap.SetDevide(device_id);
        });

        // Not Ready
        player.addListener('not_ready', ({ device_id }) => {

        });

        // Connect to the player!
        player.connect().then((connect) => {
            console.log(connect);
        });


    };

    SpotifySnap.GetInfo().then((user) => {
        console.log(user);
        let { images: [avatar], display_name } = user;
        let profile = document.querySelector('#profile-spotify');
        profile.querySelector('img').src = avatar.url;
        profile.querySelector(".card-title").innerText = display_name;
        profile.querySelector('a').href = user.external_urls.spotify;

    });

    let target = document.querySelector('#result');
    let lastTrack = SpotifySnap.GetLastPlayed().then((tracks) => {
        let { track } = tracks.items[0];

    });



    document.querySelector('#SpotifySnapform').addEventListener('submit', function(event) {
        event.preventDefault();
        let element = event.target;
        let search = element.SearchSpotify;
        target.innerHTML = '';

        SpotifySnap.Search({
            q: search.value,
            type: 'track',
            limit: 10,
            offset: 5,
        }).then((result) => {
            let { tracks } = result;
            tracks.items.map(function(track, index) {
                let { album } = track;
                let html = albumHtml({ id: album.id, src: album.images[0].url, name: track.name, artist: track.artists[0].name }, track);
                target.insertAdjacentHTML('beforeend', html);
                target.lastElementChild.addEventListener('click', function(event) {
                    SpotifySnap.PlaySong(track.uri);
                    RenderPreview(track);

                }, false);
            })
        })


    });





});
</script>